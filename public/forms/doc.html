<div data---="largeform__common.form__if:docform;icon:far fa-pencil-ruler;autofocus:true;reload:docform/reload;scrollbar:1;submit:docform/submit;width:600" class="hidden">

	<div data-scope="docform">
		<div class="padding bg-smoke">
			<div data---="input__?.name__required:1;maxlength:80__''">@(Name)</div>
			<div class="help m">@(Enter a name for this document)</div>
			<div class="row">
				<div class="col-sm-6 m">
					<div data---="input__?.collectionid__dirsource:common.collections;required:1;dirempty:@(No collection)">@(Collection)</div>
				</div>
				<div class="col-sm-6 m">
					<div data---="input__?.project__dirsource:common.projects;dircustom:1;dirempty:@(No project);dirplaceholder:@(Search or enter new);$id:docformproject__''" data-bind="?.collectionid__enabled:value&&value!=='_shared'">@(Project)</div>
				</div>
			</div>
		</div>
		<div class="padding">
			<div class="row">
				<div class="col-sm-4 col-xs-6 m">
					<div data---="input__?.icon__type:icon__''">@(Icon)</div>
				</div>
				<div class="col-sm-4 col-xs-6 m">
					<div data---="input__?.color__type:color__''">@(Color)</div>
				</div>
				<div class="col-sm-4 col-xs-6 m">
					<div data---="input__?.date__type:date;format:[dateformat]__NOW">@(Date)</div>
					<div class="help">@(Week number:) <b data-bind="!?.date__text:value.format('w')__empty"></b></div>
				</div>
			</div>
		</div>
		<hr class="nmt nmb" />
		<div class="padding">
			<div class="row">
				<div class="col-sm-4 col-xs-6 m">
					<div data---="input__?.number__maxlength:40__''">@(Own number)</div>
				</div>
				<div class="col-sm-4 col-xs-6 m">
					<div data---="input__?.hourlyrate__type:number__0">@(Hourly rate)</div>
				</div>
				<div class="col-sm-4 col-xs-6 m">
					<div data---="input__?.currencyid__dirsource:common.cl.currencies;dirempty:@(No currency)__user.currencyid">@(Currency)</div>
				</div>
			</div>
		</div>
		<hr class="nmt nmb" />
		<div class="padding">

			<div class="m">
				<div data---="checkbox__?.isprivate__null__false">@(Hide document for others)</div>
			</div>

			<div class="panel">
				<label><i class="far fa-lock-alt"></i>@(Permissions)</label>
				<div class="padding">
					<div data---="textboxlist__?.groups__placeholder:@(Type a group name and press enter)__[]">@(Groups)</div>
					<div class="help m"><span class="link exec" data-exec="?/findgroup"><i class="fas fa-search"></i>@(Find group)</span></div>
					<div data---="textboxlist__?.roles__placeholder:@(Type a role name and press enter)__[]">@(Roles)</div>
					<div class="help"><span class="link exec" data-exec="?/findrole"><i class="fas fa-search"></i>@(Find role)</span></div>
				</div>
			</div>

		</div>
	</div>
	<nav data---="validation__docform">
		<button name="submit" disabled><i class="far fa-check-circle"></i>@(SUBMIT)</button>
		<button name="cancel">@(Cancel)</button>
	</nav>
</div>

<script>

	PLUGIN('docform', function(exports) {

		exports.reload = function(com) {
			var model = GET('?');
			var id = model ? model.id : null;
			com.reconfigure({ title: id ? '@(Update document)' : '@(Create document)' });
		};

		exports.findgroup = function(el) {
			var opt = {};
			opt.element = el;
			opt.items = common.groups;
			opt.callback = function(value) {
				if (value) {
					var arr = GET('?.groups');
					if (arr.indexOf(value.id) === -1)
						PUSH('?.groups', value.id);
				}
			};
			SETTER('directory/show', opt);
		};

		exports.findrole = function(el) {
			var opt = {};
			opt.element = el;
			opt.items = common.roles;
			opt.callback = function(value) {
				if (value) {
					var arr = GET('?.roles');
					if (arr.indexOf(value.id) === -1)
						PUSH('?.roles', value.id);
				}
			};
			SETTER('directory/show', opt);
		};

		exports.submit = function(hide) {
			var model = GET('? @reset');
			SETTER('loading/show');
			AJAX('POST /api/docs/' + (model.id || ''), model, ASETTER('message/response', function(response) {
				SETTER('loading/hide', 500);

				FUNC.updateroles(model);
				FUNC.updategroups(model);

				if (common.document && common.document.id === model.id) {
					common.document.name = model.name;
					common.document.date = model.date;
					common.document.hourlyrate = model.hourlyrate;
					common.document.currencyid = model.currencyid;
					UPD('common.document.name');
					UPD('common.document.date');
					UPD('common.document.id');
					SETTER('editor/summarize');
				}

				UPD('common.collectionid');

				if (!model.id && response.value)
					EXEC('common/document', response.value);

				hide();
			}));
		};

		WATCH('?.collectionid', function(path, value) {
			var index = value ? common.collections.findIndex('id', value) : -1;
			if (index === -1)
				NUL('?.project');
		}, true);

	});

</script>